version: '3.7'

services:
    web:
        image: test
        ports: 
            - 8080:80
            - 8000:8000
        command: >
            /bin/bash -c '
            service nginx start &
            python3 manage.py collectstatic --noinput &
            python3 manage.py migrate &
            gunicorn  dashboard.wsgi --preload --workers=4 --timeout 300'
        volumes: 
            - ./media_root:/var/www/media_root
            - ./certificates:/certificates
        depends_on: 
            database:
                condition: service_healthy
    database:
        image: postgres
        environment: 
            POSTGRES_PASSWORD: example
        ports:
            - 5432:5432
        volumes: 
            - ./database:/var/lib/postgresql/data
        shm_size: 1g
        healthcheck:
            test: pg_isready -U postgres
            interval: 10s
            timeout: 3s
            retries: 3
    redis:
        image: redis
        healthcheck:
            test: redis-cli ping
            interval: 10s
            timeout: 3s
            retries: 3
    celery:
        image: test
        command: >
            /bin/bash -c '
            sleep 3;
            celery -A dashboard.celery worker'
        depends_on: 
            redis:
                condition: service_healthy
    flower:
        image: test
        command: >
            /bin/bash -c '
            sleep 3;
            flower -A dashboard'
