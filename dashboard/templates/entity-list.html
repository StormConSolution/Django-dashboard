{% extends 'layouts/new-base.html' %}

{% load data_filters %}

{% block title%}Manage Entities{% endblock%} 

{% block content %}
<div class="main-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="porject-title align-items-center d-flex flex-wrap">
                    <a href="#" class="all-data">Entity List</a>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 prject-card">
                <div class="prject-card-inner">
                    <div class="data-table table-responsive">
                        <table class="table table-striped table-borderless">
                            <thead>
                                <tr>
                                    <th scope="col">
                                        Entity Name
                                    </th>
                                    <th scope="col">
                                        Language
                                    </th>
                                    <th
                                        scope="col"
                                        class="text-center action-col"
                                    >
                                        Action
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entity in entities %}
                                <tr>
                                    <td>{{ entity.name }}</td>
                                    <td>{{ entity.lang }}</td>
                                    <td class="text-center">
                                        <!--
                      <a href="#" class="icon-link" data-toggle="modal" data-target="#testaspect" >
                        <i class="fe fe-eye" data-toggle="tooltip" data-placement="bottom" title="Test Aspect"></i>
                      </a>
-->
                                        <a
                                            href="#"
                                            class="icon-link"
                                            data-toggle="tooltip"
                                            data-role="edit-aspect-button"
                                            data-placement="bottom"
                                            title="Edit Aspect"
                                            data-entity-id="{{entity.id}}"
                                        >
                                            <i class="fe fe-edit"></i>
                                        </a>

                                        <a
                                            href="#"
                                            class="icon-link trash"
                                            data-toggle="tooltip"
                                            data-role="delete-aspect"
                                            data-placement="bottom"
                                            data-entity-id="{{entity.id}}"
                                            title="Delete Entity"
                                        >
                                            <i class="fe fe-trash-2"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="table-bottom">
                        {% if entities|length > 0 %}
                        <div class="row no-gutters">
                            <div class="col-12 col-md">
                                <div class="pagination-data">
                                    {% if entities|length > meta.page_items_to %}
                                        Showing {{meta.page_items_from}} to
                                        {{meta.page_items_to}} of {{entities |length}} entries
                                    {% else %}
                                        Showing {{meta.page_items_from}} to
                                        {{entities|length}} of {{entities|length}} entries
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-12 col-md-auto">
                                <ul class="pagination">
                                {% if page.has_previous == True %}
                                    <li>
                                        <a href="{% url 'entities' %}?page={{page.previous_page_number}}">
                                            <i class="fe fe-chevron-left"></i>
                                        </a>
                                    </li>
                                    {% endif %}
                                    {% if page.has_previous == False %}
                                        <li class="active">
                                            <a href="{% url 'entities' %}?page=1">1</a>
                                        </li>
                                        {% else %}
                                        <li>
                                            <a href="{% url 'entities' %}?page=1">1</a>
                                        </li>
                                    {% endif %} 
                                    {%if paginator.num_pages != 1%} 
                                        {% if page.page_number > 2 %}
                                        <li>
                                            <a href="#">..</a>
                                        </li>
                                        <li class="active">
                                            <a href="{% url 'entities' %}?page={{page.number}}">{{page.number}}</a>
                                        </li>
                                        {% else %}
                                            {%if page.number == 2 %}
                                            <li class="active">
                                            {%else%}
                                            <li >
                                            {%endif%}
                                            <a href="{% url 'entities' %}?page=2" class="active">2</a>
                                        </li>
                                        {% endif %} 
                                    {% endif %}
                                    {% if page.has_next == True %}
                                    <li>
                                        <a href="{% url 'entities' %}?page={{page.next_page_number}}">
                                            <i class="fe fe-chevron-right"></i>
                                        </a>
                                    </li>
                                    {%endif%}
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
            <a
                href="#"
                class="btn btn-primary mr-2"
                data-toggle="modal"
                id="create-entity-button"
                >Add New Entity</a
            >
    </div>
</div>

<!-- create-entoty modal start -->
<div
    class="modal fade"
    id="create-entity"
    tabindex="-1"
    aria-labelledby="createaspectLabel"
    aria-hidden="true"
    aria-modal="true"
    role="dialog"
>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createaspectLabel">
                    Create Entity
                </h5>
                <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                >
                    <i class="fe fe-x-circle"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-data">
                    <form method="POST" action="{% url 'entities' %}" >
                        {% csrf_token %}
                        <div class="form-group">
							<label for="entity-name" class="form-label">Entity name</label>
                            <input
                                name="entity-name"
                                type="text"
                                class="form-control"
                                id="entity-name"
                                placeholder="Enter entity name"
                            />
                        </div>
                        <div class="form-group">
                            <label for="entity-lang" class="form-label">Entity language</label>
                            <select
                                name="entity-lang"
                                type="text"
                                class="form-control"
                                id="entity-lang"
							>
							{% for code, label in languages %}
							<option {% ifequal code "en" %}selected="selected"{% endifequal %} value="{{ code }}">{{ label }}</option>
							{% endfor %}
							</select>
                        </div>
                        <div class="form-group" style="position: relative">
                            <label for="entity-classifications" class="form-label">Entity Classifications {{ "Classifications for any named entities that should match this aspect"|tooltip }}</label>
                            <input type="text" id="entity-classifications" class="tagify-classifications" name="entity-classifications" placeholder="Enter Classifications">
                        </div>
                        <div class="form-group" style="position: relative">
                            <label for="entity-aliases" class="form-label">Entity Aliases {{ "Classifications for any named entities that should match this aspect"|tooltip }}</label>
                            <input type="text" id="entity-aliases" name="entity-aliases" placeholder="Enter Classifications">
                        </div>
                        <div class="form-group">
                            <label for="create-entity-api-key-select" class="form-label"
                            >Select API key</label
                            >
                            <select
                                class="custom-select"
                                id="create-entity-api-key-select"
                                name="api-key"
                            >
                            </select>
                        </div>
                        <div id="create-entity-modal-loading"></div>
                        <button type="submit" class="btn btn-primary mt-2">
                            Save And Close
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div
    class="modal fade show"
    id="edit-aspect"
    tabindex="-1"
    aria-label="createaspectLabel"
    style="overflow-y:scroll;"
>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Aspect</h5>
                <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                >
                    <i
                        class="fe fe-x-circle"
                        onclick="resetEditAspectForm()"
                    ></i>
                </button>
            </div>
            <div class="modal-body" style="overflow-y:visible;position:relative">
                <div class="modal-data">
                    <form method="PUT" id="edit-aspect-form" data-aspect-id="NaN">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="aspect-name" class="form-label">Aspect model name</label>
                            <input
                                name="aspect-label"
                                type="text"
                                class="form-control"
                                id="edit-aspect-name"
                                placeholder="Enter Aspect Name"
                            />
                        </div>
                        <div class="form-group">
                            <label for="aspect-lang" class="form-label">Aspect model language</label>
                            <select
                                name="aspect-lang"
                                type="text"
                                class="form-control"
                                id="edit-aspect-lang"
							>
							{% for code, label in languages %}
							<option {% ifequal code "en" %}selected="selected"{% endifequal %} value="{{ code }}">{{ label }}</option>
							{% endfor %}
							</select>
                            <div class="form-check form-switch aspect-group" >
                                <p>Select predefined aspect rule</p>
                                <div class="form-check form-switch" id="edit-aspect-predefined-rules" >

                                </div>
                            </div>
                        </div>
                        <input type="hidden" name = "_method" value="PUT"></input>
                        <button
                            type="button"
                            id="edit-add-aspect-rule"
                            class="btn btn-outline-primary mr-2 mt-2"
                        >
                            Add New Aspect
                        </button>
                        <button type="submit" class="btn btn-primary mt-2">
                            Save And Close
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% include "includes/aspect-list/aspect-model-test.html" %}

<script>
new Tagify(document.querySelector(".tagify-classifications"),{
            originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(','),
    whitelist:[
                {% for classification in classifications %}
                    '{{classification.classification}}',
                {% endfor %}
            ],
    dropdown : {
        classname     : "color-blue",
        enabled       : 1,              // show the dropdown immediately on focus
        maxItems      : 10,
        position      : "text",         // place the dropdown near the typed text
        closeOnSelect : false,          // keep the dropdown open after selecting a suggestion
        highlightFirst: true
    }
});
new Tagify(document.querySelector("#entity-aliases"),{
            originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(','),
});
document.querySelector("#edit-aspect").addEventListener("submit", (e)=>{
    e.preventDefault()
    let form = document.querySelector("#edit-aspect-form")
    let formData = new FormData(form)
    let id = form.getAttribute("data-aspect-id")
    fetch(`/aspect/${id}/`, {
        method:"POST",
        body:formData
    }).then(response =>{
        if(response.status===200){
            location.reload()
        } else {
            alert("Error editing aspect")
        }
    })
})
function createAspectEditModal(id){
	// Fetch details for existing aspect and populate the form.

    url = "/aspect/" + id + "/"
    fetch(url).then(response => response.json()).then(data => {

                new Tagify(div.querySelector(".tagify"), {
                    originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(','),
                })
                new Tagify(div.querySelector(".tagify-classifications"),{
                    originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(','),
                    whitelist:[
                                {% for classification in classifications %}
                                    '{{classification.classification}}',
                                {% endfor %}
                            ],
                    dropdown : {
                        classname     : "color-blue",
                        enabled       : 1,              // show the dropdown immediately on focus
                        maxItems      : 10,
                        position      : "text",         // place the dropdown near the typed text
                        closeOnSelect : false,          // keep the dropdown open after selecting a suggestion
                        highlightFirst: true
                    }
                })
                let editButton = document.querySelector("#edit-add-aspect-rule")
                editButton.parentNode.insertBefore(div, editButton)
        document.querySelector("#edit-aspect-form").setAttribute("data-aspect-id", id)
    })
}
</script>
{% if GUEST_USER %}
<script src="/static/assets/js/entity-guest.js"></script>
{% else %}
<script src="/static/assets/js/entity.js"></script>
{% endif %}
{% endblock %}
