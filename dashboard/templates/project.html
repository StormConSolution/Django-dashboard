{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">
    <!-- BEGIN: Head-->
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=0"
            />
        <meta name="author" content="Repustate Inc." />
        <title>Repustate - Dashboard analytics</title>
        <link
            rel="apple-touch-icon"
            href="/static/app-assets/images/ico/apple-icon-120.png"
            />
        <link
            rel="shortcut icon"
            type="image/x-icon"
            href="/static/app-assets/images/ico/favicon.ico"
            />
        <link
            href="https://fonts.googleapis.com/css?family=Rubik:300,400,500,600%7CIBM+Plex+Sans:300,400,500,600,700"
            rel="stylesheet"
            />
        <!-- BEGIN: Vendor CSS-->
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/app-assets/vendors/css/vendors.min.css"
            />
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/app-assets/vendors/css/charts/apexcharts.css"
            />
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/app-assets/vendors/css/tables/datatable/datatables.min.css"
            />
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/assets/css/jquery.multiselect.css"
            />
        <link
            rel="stylesheet"
            type="text/css"
            href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"
            />
        <!-- END: Vendor CSS-->
        <!-- BEGIN: Theme CSS-->
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/app-assets/css/bootstrap.css"
            />
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/app-assets/css/bootstrap-extended.css"
            />
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/app-assets/css/colors.css"
            />
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/app-assets/css/components.css"
            />
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/app-assets/css/themes/dark-layout.css"
            />
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/app-assets/css/themes/semi-dark-layout.css"
            />
        <!-- END: Theme CSS-->
        <!-- BEGIN: Page CSS-->
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/app-assets/css/core/menu/menu-types/horizontal-menu.css"
            />
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/app-assets/css/pages/dashboard-analytics.css"
            />
        <!-- END: Page CSS-->
        <!-- BEGIN: Custom CSS-->
        <link
            rel="stylesheet"
            type="text/css"
            href="/static/assets/css/style.css"
            />
        <!-- END: Custom CSS-->
        <!-- BEGIN: Custom Js-->
        <!--  END: Custom Js-->
        <style>
            .donut-container div {
                margin-left: auto;
                margin-right: auto;
            }
        </style>
    </head>
    <!-- END: Head-->
    <!-- BEGIN: Body-->
    <body
        class="horizontal-layout horizontal-menu navbar-static dark-layout 2-columns footer-static"
        data-open="hover"
        data-menu="horizontal-menu"
        data-col="2-columns"
        data-layout="dark-layout"
        >
        {% if chart_data %}
        <script>
            var project_data = {{ chart_data|safe }};
            var project_id = {{project_id}};
        </script>
        {% endif %}
        <!-- BEGIN: Main Menu-->
        <div
            class="header-navbar navbar-expand-sm navbar navbar-horizontal navbar-sticky navbar-dark navbar-without-dd-arrow"
            role="navigation"
            data-menu="menu-wrapper"
            >
            <!-- Horizontal menu content-->
            <div
                class="navbar-container"
                id="navbarResponsive"
                data-menu="menu-container"
                >
                <!-- include /static/includes/mixins-->
                <ul
                    class="nav navbar-nav"
                    id="main-menu-navigation"
                    data-menu="menu-navigation"
                    data-icon-style="lines"
                    >
                    <li class="nav-item align-items-center">
                        <a class="navbar-brand" href="{% url 'home' %}">
                        <img src="{% static "assets/brand/logo-repustate-light.svg" %}"
                        height="36" object-fit="contain" alt="Repustate Logo"/>
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <button class="btn btn-outline btn-lg dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Projects</button>
                        <div class="dropdown-menu pre-scrollable" aria-labelledby="dropdownMenuButton">
                            {% for project in project_list %}
                            <a class="dropdown-item align-items-center" href="{% url 'projects' project_id=project.id %}"><i class="bx bx-right-arrow-alt"></i>{{project.name}}</a>
                            {% endfor %}
                        </div>
                    </li>
                    <form class="form-inline my-2 my-lg-0">
                        <input class="form-control mr-sm-2" type="text" name="daterange" />
                    </form>
                    <li class="nav-item d-flex align-items-center pl-2">
                        <select id="languages" class="d-none"name="languages" multiple="multiple">
                            {% for key, lang in languages %}
								{% if key in lang_list %}
									<option value="{{ key }}" {% if key in selected_langs %}selected{% endif %}>{{ lang }}</option>
								{% endif %}
                            {% endfor %}
                        </select>
                    </li>
                    <li class="nav-item d-flex align-items-center pl-3">
                        <select id="sources" class="d-none"name="sources" multiple="multiple">
                            {% for source in sources %}
							<option value="{{ source.label }}" {% if source.label in selected_sources %}selected{% endif %}>{{ source.label }}</option>
                            {% endfor %}
                        </select>
                    </li>
                    <li class="nav-item d-flex align-items-center pl-3">
                        <button class="btn btn-outline-dark" id="apply_filter">Apply</button>
                    </li>
                    <li class="nav-item d-flex align-items-center mr-5" id="account">
                        <a class="nav-link" href="{% url 'admin:index' %}"
                            ><i class="bx bx-user ml-50"></i> Admin</a
                            >
                    </li>
                    <li class="nav-item d-flex align-items-center mr-5" id="logout">
                        <a class="nav-link" href="{% url 'logout' %}"
                            ><i class="bx bx-power-off"></i> Logout</a
                            >
                    </li>
                </ul>
            </div>
            <!-- /horizontal menu content-->
        </div>
        <!-- END: Main Menu-->
        <!-- BEGIN: Content-->
        <div class="app-content content">
        <div class="content-overlay"></div>
        <div class="content-wrapper">
            <div class="content-header row"></div>
            <div class="content-body">
                <!-- Dashboard Analytics Start -->
                <div class="container-fluid mb-3">
                    <div class="row">
						<div class="col-10">
							<h1>{{ project.name }}
								<a class="text-white" href="{% url 'projects' project_id=project.id %}?from={{ earliest }}&to={{ latest }}">
									<small style="font-size:18px;" class="text-muted">See all {{ total|intcomma }} data items &rarr;</small></a>
							</h1>
						</div>
						<div class="col-2 text-right"><h5><a class="text-white" href="{% url 'projects' project_id=project.id %}">Reset filters</a></h5></div>
                    </div>
                </div>
				{% for alert in project.alert_set.all %}
				<div class="alert alert-danger alert-dismissible fade show" role="alert">
					<strong>{{ alert.title }}</strong> {{ alert.description }}
					<button type="button" class="close" data-dismiss="alert" aria-label="Close">
					<span aria-hidden="true">&times;</span>
					</button>
				</div>
				{% endfor %}
				<div class="container">
					<div class="row">
						{% for summary in project.summary_set.all %}
						<div class="col-3">
							<div class="card">
								<div class="card-body">
									<h5 class="card-title">{{ summary.title }}</h5>
									<p class="card-text">{{ summary.description }}</p>
								</div>
							</div>
						</div>
						{% endfor %}
					</div>
				</div>
                <div class="row ml-3">
                    <!-- Website Analytics Starts-->
                    <div class="col-md-6 col-sm-12">
                        <div class="card border-0">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h4 class="card-title"><s></s>Sentiment Trend</h4>
                            </div>
                            <div class="card-content">
                                <div class="card-body pb-1">
                                    <div class="d-flex justify-content-around align-items-center flex-wrap" >
                                        <div class="user-analytics">
                                            <span class="align-middle text-muted">Total data items</span>
                                            <div class="d-flex">
                                                <h3 class="mt-1 ml-50">{{ total_data }}</h3>
                                            </div>
                                        </div>
                                        <div class="sessions-analytics">
                                            <span class="align-middle text-muted">Total positive</span >
                                            <div class="d-flex">
                                                <h3 class="mt-1 ml-50">{{ total_positive }}</h3>
                                            </div>
                                        </div>
                                        <div class="bounce-rate-analytics">
                                            <span class="align-middle text-muted">Total negative</span>
                                            <div class="d-flex">
                                                <h3 class="mt-1 ml-50">{{ total_negative }}</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="analytics-bar-chart"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-12 pr-5">
                        <div class="card border-0">
                            <div class="card-header d-flex justify-content-between align-items-center" >
                                <h4 class="card-title"><s></s>Overall Sentiment</h4>
                            </div>
                            <div class="card-content ">
                                <div class="card-body pb-1 mb-1">
                                    <div class="card-body donut-chart-wrapper ">
                                        <ul class="list-inline d-flex justify-content-around align-items-center mb-1 mt-3" >
                                            <li class="d-flex align-items-center">
                                                <span class="bullet bullet-xm bullet-primary mr-50" ></span>Positive
                                            </li>
                                            <li class="d-flex align-items-center">
                                                <span class="bullet bullet-xm bullet-warning mr-50"></span >Negative
                                            </li>
                                            <li class="d-flex align-items-center">
                                                <span class="bullet bullet-xm bullet-info mr-50"></span>Neutral
                                            </li>
                                        </ul>
                                        <div id="donut-chart" class="d-flex flex-1 justify-content-center"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
				<div class="container-fluid">
					<div class="col-md-12">
						<div class="card border-0 mr-4">
							<div class="card-header">
								<h4 class="card-title">Volume by Source</h4>
							</div>
							<div class="card-content" >
								<div class="card-body">
									<div class="d-flex flex-row flex-wrap" >
										<div style="width: 100%; height: 500px;" id="source-volume"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				{% if project.aspect_model %}
                <div class="container-fluid">
                    <!-- Activity Card Starts-->
                    <div class="d-flex flex-row flex-wrap" >
                        <div class="col-12 activity-card">
                            <div class="card border-0">
                                <div class="card-header">
                                    <h4 class="card-title">Aspects</h4>
                                </div>
                                <div class="card-content">
                                    <div class="card-body pt-1">
										{% for aspect in aspect_data|dictsortreversed:"percent" %}
                                        <a href="{% url 'aspect-names' project.id %}?aspectname={{ aspect.label }} ">
                                            <div class="d-flex activity-content">
                                                <div class="activity-progress flex-grow-1">
													<span class="text-muted d-inline-block mb-50">{{ aspect.label }} ({{ aspect.percent }}%)</span>
                                                    <span class="float-right">{{ aspect.count|intcomma }}</span>
                                                    <div class="progress progress-bar-{{ aspect.color }} progress-sm">
                                                        <div
                                                            class="progress-bar"
                                                            role="progressbar"
                                                            aria-valuenow="{{ aspect.percent }}"
                                                            style="width:{{ aspect.percent }}%; background-color:{{ aspect.color }} !important;"
                                                            ></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container-fluid">
                    <!-- Activity Card Starts-->
                    <div class="d-flex flex-row flex-wrap" >
                        <div class="col-12 activity-card">
                            <div class="card border-0">
                                <div class="card-header">
                                    <h4 class="card-title">Aspect Co-occurrence</h4>
                                </div>
                                <div class="card-content">
                                    <div class="card-body pt-1">
										<div id="aspect-co"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
				<div class="container-fluid">
					<div class="col-md-12">
						<div class="card border-0 mr-4">
							<div class="card-header">
								<h4 class="card-title">Aspect by Sentiment</h4>
							</div>
							<div class="card-content" >
								<div class="card-body">
									<div class="d-flex flex-row flex-wrap" >
										<div style="width: 100%; height: 500px;" id="aspect-by-sentiment"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
                <div class="container-fluid">
					<div class="col-md-12">
						<div class="card border-0 mr-4">
							<div class="card-header">
								<h4 class="card-title">Sentiment for each Aspect</h4>
							</div>
							<div class="card-content" >
								<div class="card-body">
									<div class="d-flex flex-row flex-wrap" >
										<div style="width: 100%;" id="sentiment-for-each-aspect"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
                <div class="container-fluid">
					<div class="col-md-12">
						<div class="card border-0 mr-4">
							<div class="card-header">
								<h4 class="card-title">Top topics per aspect</h4>
							</div>
                            <div class="row">
                                <div class="col-sm-12 col-md-6 d-flex flex-row"><label class="m-1">Show up to</label><select id="select-max-topics-per-aspect" name="max-topics" aria-controls="aspect-topics" class="m-1 custom-select custom-select-sm form-control form-control-sm" style="max-width: 4rem;"><option value="6">6</option><option value="8">8</option><option value="10">10</option></select><label class="m-1"> topics per aspect</label></div>
                            </div>
							<div class="card-content" >
								<div class="card-body">
									<div class="d-flex flex-row flex-wrap" >
										<div style="width: 100%;" id="top-topics-per-aspect"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="container-fluid">
					<div class="col-md-12">
						<section class="basic-datatable">
							<div class="card border-0">
								<div class="card-header">
									<h4 class="card-title">Aspect Topic Breakdown</h4>
								</div>
								<div class="card-content">
									<div class="card-body card-dashboard">
										<p class="card-text"></p>
										<div class="table-responsive">
											<table class="table" id="aspect-topics">
												<thead>
													<tr>
														<th>Topic</th>
														<th>Aspect</th>
														<th>Positives</th>
														<th>Negatives</th>
													</tr>
												</thead>
											</table>
										</div>
									</div>
								</div>
							</div>
						</section>
					</div>
				</div>
				{% endif %}
				<div class="container-fluid">
					<div class="col-md-12">
						<section class="basic-datatable">
							<div class="card border-0">
								<div class="card-header">
									<h4 class="card-title">Entities</h4>
								</div>
								<div class="card-content">
									<div class="card-body card-dashboard">
										<p class="card-text"></p>
										<div class="table-responsive">
											<table class="table" id="entities">
												<thead>
													<tr>
														<th>Entity</th>
														<th>Classifications</th>
														<th>Frequency</th>
													</tr>
												</thead>
											</table>
										</div>
									</div>
								</div>
							</div>
						</section>
					</div>
				</div>
				<div class="container-fluid">
					<div class="col-md-12">
						<section class="basic-datatable">
							<div class="card border-0 mr-4">
								<div class="card-header">
									<h4 class="card-title">Data Items</h4>
								</div>
								<div class="card-content">
									<div class="card-body card-dashboard">
										<p class="card-text"></p>
										<div class="table-responsive">
											<table class="table" id="data-entries">
												<thead>
													<tr>
														<th>Date</th>
														<th>Text</th>
														<th>Source</th>
														<th>Weighted</th>
														<th>Raw</th>
														<th>Language</th>
													</tr>
												</thead>
											</table>
										</div>
									</div>
								</div>
							</div>
						</section>
					</div>
				</div>
			</div>
		</div>

		<div id="aspectModal" class="modal" tabindex="-1" role="dialog">
			<div class="modal-dialog modal-lg" role="document">
				<div class="modal-content">
					<div class="modal-header">
					<h5 id="modal-title" class="modal-title">Aspect topic detailed view</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<table class="table" id="modal-table">
							<thead>
								<tr>
									<th>Sentiment Text</th>
									<th>Value</th>
								</tr>
							</thead>
						</table>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>

        <!-- Dashboard Analytics end -->
        <!-- END: Content-->
        <div class="sidenav-overlay"></div>
        <div class="drag-target"></div>
        <!-- BEGIN: Footer-->
        <footer class="footer footer-static footer-dark"></footer>
        <!-- END: Footer-->
        <script
            src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script> 
        <!-- BEGIN: Vendor JS-->
        <script src="/static/app-assets/vendors/js/vendors.min.js"></script>
        <!-- BEGIN Vendor JS-->
        <!-- BEGIN: Page Vendor JS-->
        <script src="/static/app-assets/vendors/js/ui/jquery.sticky.js"></script>
        <script
            type="text/javascript"
            src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"
            ></script>
        <script src="/static/app-assets/vendors/js/charts/apexcharts.min.js"></script>
        <script src="/static/app-assets/vendors/js/extensions/dragula.min.js"></script>
        <script src="/static/app-assets/vendors/js/tables/datatable/datatables.min.js"></script>
        <script src="/static/app-assets/vendors/js/tables/datatable/dataTables.bootstrap4.min.js"></script>
        <script src="/static/app-assets/vendors/js/tables/datatable/dataTables.buttons.min.js"></script>
        <script src="/static/app-assets/vendors/js/tables/datatable/buttons.html5.min.js"></script>
        <script src="/static/app-assets/vendors/js/tables/datatable/buttons.print.min.js"></script>
        <script src="/static/app-assets/vendors/js/tables/datatable/buttons.bootstrap.min.js"></script>
        <script src="/static/app-assets/vendors/js/tables/datatable/pdfmake.min.js"></script>
        <script src="/static/app-assets/vendors/js/tables/datatable/vfs_fonts.js"></script>
        <!-- END: Page Vendor JS-->
        <!-- BEGIN: Theme JS-->
        <script src="/static/app-assets/js/scripts/configs/horizontal-menu.js"></script>
        <script src="/static/app-assets/js/scripts/configs/vertical-menu-dark.js"></script>
        <script src="/static/app-assets/js/core/app-menu.js"></script>
        <script src="/static/app-assets/js/core/app.js"></script>
        <script src="/static/app-assets/js/scripts/components.js"></script>
        <script src="/static/app-assets/js/scripts/footer.js"></script>
        <!-- END: Theme JS-->
        <script
            type="text/javascript"
            src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"
            ></script>
        <!-- BEGIN: Page JS-->
        <script src="/static/assets/js/dashboard-analytics.js"></script>
        <script
            src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
            integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
            crossorigin="anonymous"></script>
        <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
        <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
        <script src="https://cdn.amcharts.com/lib/4/themes/dataviz.js"></script>
        <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
        <script src="/static/assets/js/jquery.multiselect.js"></script>
        <!-- END: Page JS-->
        
		<script type="text/javascript">
            $(function() {
            
            $('#data-entries').DataTable( {
				 "ajax": "{% url 'data-entries' project.id %}?{{ query_string }}",
			     "serverSide": true,
				 "order": [[0, "desc"]],
				 "columnDefs": [{
					  // The `data` parameter refers to the data for the cell (defined by the
					  // `data` option, which defaults to the column being worked with, in
					  // this case `data: 0`.
					  "render": function ( data, type, row ) {
						   let obj = JSON.parse(data);
						   if (obj.url) {
							   return `<a target="_blank" href="${obj.url}">${obj.text}</a>`;
						   } else {
							   return obj.text
						   }
					  },
					  "targets": 1
					}
				 ]
            });
			
            $('#entities').DataTable( {
				 "ajax": "{% url 'entities' project.id %}?{{ query_string }}",
			     "serverSide": true,
				 "order": [[2, "desc"]],
				 "columnDefs": [{
				  "render": function ( data, type, row ) {
					return "<a href='?entity="+encodeURI(data)+"'>"+data+"</a>";
				  },
				  "targets": 0
				}
			 ]
            });
		
            $('#aspect-topics').DataTable( {
             "ajax": "{% url 'aspect-topics' project.id %}?{{ query_string }}",
			 "serverSide": true,
             "order": [[0, "desc"]],
             "columnDefs": [ 
				 {
				  "render": function ( data, type, row ) {
					return "<a href='?aspecttopic="+encodeURI(data)+"'>"+data+"</a>";
				  },
				  "targets": 0
				},
				 {
				  "render": function ( data, type, row ) {
					  let t = row[0];
					  return `<a href='javascript:aspect_modal("${t}",1,0)'>Details</a>`
				  },
				  "targets": 2
				},
				 {
				  "render": function ( data, type, row ) {
					  let t = row[0];
					  return `<a href='javascript:aspect_modal("${t}",-1,0)'>Details</a>`
				  },
				  "targets": 3
				}
			 ]
            });
            
            <!-- multi select widget function-->
            $("#sources").multiselect({noneSelectedText:'Choose Sources'});
            $("#languages").multiselect({noneSelectedText:'Choose languages'});
            $( "#apply_filter" ).click(function(event) {
               //event.preventDefault();
               var languages = $("#languages").multiselect().val();
               var sources = $("#sources").multiselect().val();
              
              	const urlParams = new URLSearchParams(window.location.search);
              
               urlParams.set('filter_language', languages);
               urlParams.set('filter_source', sources);
               window.location.href = window.location.origin + window.location.pathname + '?' + urlParams.toString();
            });
                
            <!--function end here--> 
            
            <!-- date-range widget function-->
            $('input[name="daterange"]').daterangepicker({
             opens: 'left',
             startDate:'{{ start_date |date:"m-d-Y" }}',
             endDate:'{{ end_date |date:"m-d-Y" }}',
             }, function(start, end, label) {
				const urlParams = new URLSearchParams(window.location.search);
				urlParams.set('from', start.format('YYYY-MM-DD'));
				urlParams.set('to', end.format('YYYY-MM-DD'));
				window.location.href = window.location.origin + window.location.pathname + '?' + urlParams.toString();
				 });
                });

			//  Render a modal showing positive and negative for a particular topic.
			function aspect_modal(topic, sentiment, mode) {
				if (mode == 0) {
					$('#modal-table').DataTable( {
						 "ajax": "{% url 'aspect-topic-detail' project.id %}?topic="+encodeURI(topic)+"&sentiment="+sentiment,
						 "destroy": true
					})

					$("#modal-title").html("Aspect topic detailed view - "+topic)
				} else {
					$('#modal-table').DataTable( {
						 "ajax": "{% url 'aspect-topic-summary' project.id %}?topic="+encodeURI(topic)+"&sentiment="+sentiment,
						 "order": [[1, "desc"]],
						 "destroy": true
					})

					$("#modal-title").html("Aspect topic summary view - "+topic)
				}
				$('#aspectModal').modal();
			}
        </script>
    </body>
    <!-- END: Body-->
</html>
