{% extends 'layouts/new-base.html' %}

{% load data_filters %}

{% block title%}Manage Aspects{% endblock%} 

{% block content %}
<div class="main-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="porject-title align-items-center d-flex flex-wrap">
                    <a href="#" class="all-data">Aspect List</a>
                    <div class="ml-auto">
                        <form>
                            <div class="form-row align-items-center">
                                {% comment %}
                                <div class="col-auto">
                                    <div
                                        class="per-page align-items-center d-flex"
                                    >
                                        Show
                                        <select
                                            class="custom-select"
                                            id="inputGroupSelect01"
                                        >
                                            <option selected>10</option>
                                            <option value="1">20</option>
                                            <option value="2">30</option>
                                            <option value="3">40</option>
                                        </select>
                                        Entries
                                    </div>
                                </div>
                                {% endcomment %} {% comment %}
                                <div class="col-auto">
                                    <div class="data-search">
                                        <input
                                            type="text"
                                            class="form-control"
                                            placeholder="Search"
                                        />
                                    </div>
                                </div>
                                {% endcomment %}

                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 prject-card">
                <div class="prject-card-inner">
                    <div class="data-table table-responsive">
                        <table class="table table-striped table-borderless">
                            <thead>
                                <tr>
                                    <th scope="col">
                                        Aspect Name
                                    </th>
                                    <th scope="col">
                                        Language
                                    </th>
                                    <th scope="col">
                                        Projects using
                                    </th>
                                    <th scope="col" class="text-center">
                                        No. Rules
                                    </th>
                                    <th
                                        scope="col"
                                        class="text-center action-col"
                                    >
                                        Action
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aspect in aspects %}
                                <tr>
                                    <td>{{ aspect.label }}</td>
                                    <td>{{ aspect.lang }}</td>
                                    <td>
                                    {% for project in aspect.projects %}
                                        {% if forloop.last %}
                                        {{project.name}}
                                        {% else %}
                                        {{project.name}},
                                        {% endif %}
                                    {% endfor %}
                                    </td>

                                    <td class="text-center">
                                        {{aspect.rules | length}}
                                    </td>
                                    <td class="text-center">
                                        <!--
                      <a href="#" class="icon-link" data-toggle="modal" data-target="#testaspect" >
                        <i class="fe fe-eye" data-toggle="tooltip" data-placement="bottom" title="Test Aspect"></i>
                      </a>
-->
                                        <a
                                            href="#"
                                            class="icon-link"
                                            data-toggle="tooltip"
                                            data-role="edit-aspect-button"
                                            data-placement="bottom"
                                            title="Edit Aspect"
                                            data-aspect-id="{{aspect.id}}"
                                        >
                                            <i class="fe fe-edit"></i>
                                        </a>

                                        <a
                                            href="#"
                                            class="icon-link trash"
                                            data-toggle="tooltip"
                                            data-role="delete-aspect"
                                            data-placement="bottom"
                                            data-aspect-id="{{aspect.id}}"
                                            title="Delete Aspect"
                                        >
                                            <i class="fe fe-trash-2"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="table-bottom">
                        {% if aspects|length > 0 %}
                        <div class="row no-gutters">
                            <div class="col-12 col-md">
                                <div class="pagination-data">
                                    {% if aspects|length > meta.page_items_to %}
                                        Showing {{meta.page_items_from}} to
                                        {{meta.page_items_to}} of {{aspects |length}} entries
                                    {% else %}
                                        Showing {{meta.page_items_from}} to
                                        {{aspects|length}} of {{aspects |length}} entries
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-12 col-md-auto">
                                <ul class="pagination">
                                {% if page.has_previous == True %}
                                    <li>
                                        <a href="{% url 'aspects' %}?page={{page.previous_page_number}}">
                                            <i class="fe fe-chevron-left"></i>
                                        </a>
                                    </li>
                                    {% endif %}
                                    {% if page.has_previous == False %}
                                        <li class="active">
                                            <a href="{% url 'aspects' %}?page=1">1</a>
                                        </li>
                                        {% else %}
                                        <li>
                                            <a href="{% url 'aspects' %}?page=1">1</a>
                                        </li>
                                    {% endif %} 
                                    {%if paginator.num_pages != 1%} 
                                        {% if page.page_number > 2 %}
                                        <li>
                                            <a href="#">..</a>
                                        </li>
                                        <li class="active">
                                            <a href="{% url 'aspects' %}?page={{page.number}}">{{page.number}}</a>
                                        </li>
                                        {% else %}
                                            {%if page.number == 2 %}
                                            <li class="active">
                                            {%else%}
                                            <li >
                                            {%endif%}
                                            <a href="{% url 'aspects' %}?page=2" class="active">2</a>
                                        </li>
                                        {% endif %} 
                                    {% endif %}
                                    {% if page.has_next == True %}
                                    <li>
                                        <a href="{% url 'aspects' %}?page={{page.next_page_number}}">
                                            <i class="fe fe-chevron-right"></i>
                                        </a>
                                    </li>
                                    {%endif%}
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
            <a
                href="#"
                class="btn btn-primary mr-2"
                id="test-aspect-button"
                >Test Aspects</a
            >
            <a
                href="#"
                class="btn btn-primary mr-2"
                data-toggle="modal"
                data-target="#createaspect"
                >Add New Aspect</a
            >
        <!--<a href="#" class="btn btn-primary mr-2" data-toggle="modal" data-target="#testaspect" >
        Test aspect modal
      </a>-->
        {% comment %}
        <a
            href="#"
            class="btn btn-primary mr-2"
            data-toggle="modal"
            data-target="#createaspect"
        >
            Create aspect modal
        </a>
        {% endcomment %}
    </div>
</div>

<!-- modal start -->




<!-- Test-Aspect modal End -->

<!-- create-Aspect modal start -->
<div
    class="modal fade"
    id="createaspect"
    tabindex="-1"
    aria-labelledby="createaspectLabel"
    aria-hidden="true"
    aria-modal="true"
    role="dialog"
>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createaspectLabel">
                    Create Aspect Model
                </h5>
                <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                >
                    <i class="fe fe-x-circle"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-data">
                    <form method="POST" action="{% url 'aspects' %}">
                        {% csrf_token %}
                        <div class="form-group">
							<label for="aspect-name" class="form-label">Aspect model name</label>
                            <input
                                name="aspect-label"
                                type="text"
                                class="form-control"
                                id="aspect-name"
                                placeholder="Enter aspect model name"
                            />
                        </div>
                        <div class="form-group">
                            <label for="aspect-lang" class="form-label">Aspect model language</label>
                            <select
                                name="aspect-lang"
                                type="text"
                                class="form-control"
                                id="aspect-lang"
							>
							{% for code, label in languages %}
							<option {% ifequal code "en" %}selected="selected"{% endifequal %} value="{{ code }}">{{ label }}</option>
							{% endfor %}
							</select>
                        </div>
                        <div class="form-check form-switch aspect-group">
							<label class="form-label">Select predefined aspect rules {{ "These are prebuilt machine learned aspect sentiment models. Select as many as you like."|tooltip }}</label>
                            <div class="form-check form-switch"  >
                        {% for predefined_aspect_rule in predefined_aspect_rules %}
						<input id="predefined_aspect_{{ predefined_aspect_rule.id }}" class="form-check-input" type="checkbox" value="{{predefined_aspect_rule.label}}" class="form-check-input" name="predefined-rule"/>
						<label for="predefined_aspect_{{ predefined_aspect_rule.id }}" class="form-check-label" >{{predefined_aspect_rule.label}}</label>
                            <br>
                        {% endfor %}
                            </div>
                        </div>
                        <div class="aspect-group" style="position: relative">
                            <div class="form-group">
                                <p
                                    style="
                                        position: absolute;
                                        top: 1rem;
                                        right: 1rem;
                                        cursor: pointer;
                                    "
                                    data-role="delete-aspect-rule"
                                >
                                    X
                                </p>
                                <label for="Rule-name" class="form-label">Aspect Name</label>
                                <input
                                    name="rule-name"
                                    type="text"
                                    class="form-control"
                                    id="Rule-name"
                                    value=""
                                    placeholder="Enter Rule Name"
                                />
                            </div>
                            <div class="form-group">
								<label for="Rule-name" class="form-label">Aspect Keywords and Phrases {{ "Comma separated words and phrases that define this aspect"|tooltip }}</label>
                                <textarea
                                    name="rule-definition"
                                    class="tagify"
									rows=5
                                    value=""
                                    autofocus
									></textarea>
                            </div>
                            <div class="form-group" style="position: relative">
								<label for="aspect-classifications" class="form-label">Aspect Classifications {{ "Classifications for any named entities that should match this aspect"|tooltip }}</label>
                                <input type="text" id="aspect-classifications" class="tagify-classifications" name="rule-classification" placeholder="Enter Classifications">
                            </div>
                        </div>
                        <button
                            type="button"
                            data-role="add-aspect-rule"
                            class="btn btn-outline-primary mr-2 mt-2"
                        >
                            Add New Aspect
                        </button>
                        <button type="submit" class="btn btn-primary mt-2">
                            Save And Close
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div
    class="modal fade show"
    id="edit-aspect"
    tabindex="-1"
    aria-label="createaspectLabel"
    style="z-index: 100;overflow-y:scroll;"
>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Aspect</h5>
                <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                >
                    <i
                        class="fe fe-x-circle"
                        onclick="resetEditAspectForm()"
                    ></i>
                </button>
            </div>
            <div class="modal-body" style="overflow-y:visible;position:relative">
                <div class="modal-data">
                    <form method="PUT" id="edit-aspect-form" data-aspect-id="NaN">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="aspect-name" class="form-label">Aspect model name</label>
                            <input
                                name="aspect-label"
                                type="text"
                                class="form-control"
                                id="edit-aspect-name"
                                placeholder="Enter Aspect Name"
                            />
                        </div>
                        <div class="form-group">
                            <label for="aspect-lang" class="form-label">Aspect model language</label>
                            <select
                                name="aspect-lang"
                                type="text"
                                class="form-control"
                                id="edit-aspect-lang"
							>
							{% for code, label in languages %}
							<option {% ifequal code "en" %}selected="selected"{% endifequal %} value="{{ code }}">{{ label }}</option>
							{% endfor %}
							</select>
                            <div class="form-check form-switch aspect-group" >
                                <p>Select predefined aspect rule</p>
                                <div class="form-check form-switch" id="edit-aspect-predefined-rules" >

                                </div>
                            </div>
                        </div>
                        <input type="hidden" name = "_method" value="PUT"></input>
                        <button
                            type="button"
                            id="edit-add-aspect-rule"
                            class="btn btn-outline-primary mr-2 mt-2"
                        >
                            Add New Aspect
                        </button>
                        <button type="submit" class="btn btn-primary mt-2">
                            Save And Close
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% include "includes/aspect-list/aspect-model-test.html" %}
<script>
function closeTestAspectModal(){
    document.querySelector("#test-aspect-modal").style.display="none"
}

document.querySelector("#test-aspect-button").addEventListener("click", ()=>{
    document.querySelector("#test-aspect-modal").style.display="block"
})
let edit_aspect_rule_count = 1
function resetEditAspectForm(){
    document.querySelector('#edit-aspect').style.display='none'
    document.querySelectorAll("[data-role='edit-aspect-group']").forEach(element=>{
        element.remove()
    })
    aspectPredefinedRulesDiv.innerHTML = ""
}
document.querySelector("#edit-add-aspect-rule").addEventListener("click", (e)=>{
    let currentElement = e.currentTarget
        let parent = currentElement.parentNode
        let div = document.createElement("div")
        div.setAttribute("data-role", "edit-aspect-group")
        div.className = "aspect-group"
        div.style.position = "relative"
        let element =
            `
        <div class="form-group">
            <p style="position:absolute; top:1rem;right:1rem;cursor:pointer;" data-role="delete-aspect-rule">X</p>
            <label for="Rule-name" class="form-label">Aspect Name</label>
            <input name="rule-name"type="text" class="form-control" id="Rule-name" value="" placeholder="Enter Rule Name">
        </div>
        <div class="form-group">
            <label for="Rule-name" class="form-label">Aspect Definition</label>
            <input name='rule-definition' class="tagify" value='' autofocus>
        </div>
        <div class="form-group" style="position: relative">
            <label for="aspect-classifications" class="form-label">Aspect Classifications</label>
            <input type="text" id="aspect-classifications" class="tagify-classifications" name="rule-classification" placeholder="Enter Classifications">
        </div>
    `
        div.innerHTML = element
        div.querySelector("[data-role='delete-aspect-rule']").addEventListener("click", (e) => {
            e.currentTarget.parentNode.parentNode.remove()
            edit_aspect_rule_count--
        })
        new Tagify(div.querySelector(".tagify"), {
            originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(','),
        })
        new Tagify(div.querySelector(".tagify-classifications"),{
            originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(','),
            whitelist:[
                        {% for classification in classifications %}
                            '{{classification.classification}}',
                        {% endfor %}
                    ],
            dropdown : {
                classname     : "color-blue",
                enabled       : 1,              // show the dropdown immediately on focus
                maxItems      : 10,
                position      : "text",         // place the dropdown near the typed text
                closeOnSelect : false,          // keep the dropdown open after selecting a suggestion
                highlightFirst: true
            }
        });
        parent.insertBefore(div, currentElement)
        edit_aspect_rule_count++
})
document.querySelector("#edit-aspect").addEventListener("submit", (e)=>{
    e.preventDefault()
    let form = document.querySelector("#edit-aspect-form")
    let formData = new FormData(form)
    let id = form.getAttribute("data-aspect-id")
    fetch(`/aspect/${id}/`, {
        method:"POST",
        body:formData
    }).then(response =>{
        if(response.status===200){
            location.reload()
        } else {
            alert("Error editing aspect")
        }
    })
})
let aspectPredefinedRulesDiv = document.querySelector("#edit-aspect-predefined-rules")
function createAspectEditModal(id){
	// Fetch details for existing aspect and populate the form.

    url = "/aspect/" + id + "/"
    fetch(url).then(response => response.json()).then(data => {

		document.querySelector("#edit-aspect-name").value = data.aspect_label
		document.querySelector("#edit-aspect-lang").value = data.aspect_lang
        let predefinedRules = {{predefined_aspect_rules | safe}}
        let aspectPredefinedRules = data.rules.filter(x => x.predefined)
        for(predefinedRule of predefinedRules){
                let html = ""
                let isRuleInUse = false
                for(rule of data.rules){
                    if(rule.rule_label == predefinedRule.label){
                        isRuleInUse = true
                    }
                }
                if(isRuleInUse){
                    html = `
                    <input value="${predefinedRule.label}" class="form-check-input" type="checkbox" name="predefined-rules" checked />
                    <label class="form-check-label" >${predefinedRule.label}</label>
                    <br>
                    `
                } else {
                    html = `
                    <input value="${predefinedRule.label}" class="form-check-input" type="checkbox" name="predefined-rules" />
                    <label class="form-check-label" >${predefinedRule.label}</label>
                    <br>
                    `
                }
                aspectPredefinedRulesDiv.insertAdjacentHTML("beforeend", html)
        }
        for(rule of data.rules){
            if(!rule.predefined){
                let div = document.createElement("div")
                div.className = "aspect-group"
                div.style.position = "relative"
                div.setAttribute("data-role", "edit-aspect-group")
                let element=`                            
                    <div class="form-group">
                        <p style="position:absolute; top:1rem;right:1rem;cursor:pointer;"
                            data-role="delete-aspect-rule">X</p>
                        <label for="Rule-name" class="form-label">Aspect Name</label>
                        <input name="rule-name" type="text" class="form-control" value="${rule.rule_label}"
                            placeholder="Enter Rule Name">
                    </div>
                    <div class="form-group">
                        <label for="Rule-name" class="form-label">Aspect Definition</label>
                        <input name='rule-definition' class="tagify" value='${rule.rule_definitions}' autofocus>
                    </div>
                    <div class="form-group" style="position: relative">
                        <label for="aspect-classifications" class="form-label">Aspect Classifications</label>
                        <input type="text" id="aspect-classifications" class="tagify-classifications" name="rule-classification" placeholder="Enter Classifications" value='${rule.rule_classifications}'>
                    </div>
                    <input type="hidden" name="rule-id" value="${rule.rule_id}"></input>
                `
                div.innerHTML = element
                div.querySelector("[data-role='delete-aspect-rule']").addEventListener("click", (e) => {
                    e.currentTarget.parentNode.parentNode.remove()
                })
                new Tagify(div.querySelector(".tagify"), {
                    originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(','),
                })
                new Tagify(div.querySelector(".tagify-classifications"),{
                    originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(','),
                    whitelist:[
                                {% for classification in classifications %}
                                    '{{classification.classification}}',
                                {% endfor %}
                            ],
                    dropdown : {
                        classname     : "color-blue",
                        enabled       : 1,              // show the dropdown immediately on focus
                        maxItems      : 10,
                        position      : "text",         // place the dropdown near the typed text
                        closeOnSelect : false,          // keep the dropdown open after selecting a suggestion
                        highlightFirst: true
                    }
                })
                let editButton = document.querySelector("#edit-add-aspect-rule")
                editButton.parentNode.insertBefore(div, editButton)
            }
        }
        document.querySelector("#edit-aspect-form").setAttribute("data-aspect-id", id)
    })
}

document.querySelectorAll('[data-role="edit-aspect-button"]').forEach((element) => {

    element.addEventListener("click", (e) => {
        let modal = document.querySelector("#edit-aspect")
        modal.style.display = "block"
        createAspectEditModal(element.getAttribute("data-aspect-id"))
    })
})
document.querySelectorAll('[data-role="delete-aspect-rule"]').forEach((element) => {
    element.addEventListener("click", (e) => {
        e.currentTarget.parentNode.parentNode.remove()
        count_rules--
    })
})
document.querySelectorAll('[data-role="delete-aspect"]').forEach((e) => {
    e.addEventListener("click", (e) => {
        let aspectId = e.currentTarget.getAttribute("data-aspect-id")
        fetch("/aspect/" + aspectId + "/", { method: "DELETE" }).then(response => {
            if (response.status == 200) {
                location.reload()
            } else {
                alert("Error deleting aspect")
            }
        })
    })
})
let count_rules = 1
document.querySelector("[data-role='add-aspect-rule']").addEventListener("click", (e) => {
    let currentElement = e.currentTarget
    let parent = currentElement.parentNode
    count_rules++
    let div = document.createElement("div")
    div.className = "aspect-group"
    div.style.position = "relative"
    let element =
        `
    <div class="form-group" >
        <p style="position:absolute; top:1rem;right:1rem;cursor:pointer;" data-role="delete-aspect-rule">X</p>
        <label for="Rule-name" class="form-label">Aspect Name</label>
        <input name="rule-name"type="text" class="form-control" id="Rule-name" value="" placeholder="Enter Rule Name">
    </div>
    <div class="form-group">
        <label for="Rule-name" class="form-label">Aspect Definition</label>
        <input name='rule-definition' class="tagify" value='' autofocus>
    </div>
    <div class="form-group" style="position: relative">
        <label for="aspect-classifications" class="form-label">Aspect Classifications</label>
        <input type="text" id="aspect-classifications" class="tagify-classifications" name="rule-classification" placeholder="Enter Classifications">
    </div>
`
    div.innerHTML = element
    div.querySelector("[data-role='delete-aspect-rule']").addEventListener("click", (e) => {
        e.currentTarget.parentNode.parentNode.remove()
        count_rules--
    })



    parent.insertBefore(div, currentElement)
    new Tagify(div.querySelector(".tagify"), {
        originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(','),
    })
    new Tagify(div.querySelector(".tagify-classifications"),{
        originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(','),
        whitelist:[
                    {% for classification in classifications %}
                        '{{classification.classification}}',
                    {% endfor %}
                ],
        dropdown : {
            classname     : "color-blue",
            enabled       : 1,              // show the dropdown immediately on focus
            maxItems      : 10,
            position      : "text",         // place the dropdown near the typed text
            closeOnSelect : false,          // keep the dropdown open after selecting a suggestion
            highlightFirst: true
        }
    });
})
    {% comment %} let dataTableModalContainer = document.querySelector("#data-table-modal")
    let dataTableModalCloseButton = document.querySelector("#close-data-table-modal")
    dataTableModalCloseButton.addEventListener("click", (e) => {
        dataTableModalContainer.style.display = 'none'
    }) {% endcomment %}
    new Tagify(document.querySelector(".tagify-classifications"),{
                originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(','),
        whitelist:[
                    {% for classification in classifications %}
                        '{{classification.classification}}',
                    {% endfor %}
                ],
        dropdown : {
            classname     : "color-blue",
            enabled       : 1,              // show the dropdown immediately on focus
            maxItems      : 10,
            position      : "text",         // place the dropdown near the typed text
            closeOnSelect : false,          // keep the dropdown open after selecting a suggestion
            highlightFirst: true
        }
    });
    new Tagify(document.querySelector(".tagify"),{
                originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(','),
    });
</script>
<!--<script src="/static/assets/js/bundle.js"></script>-->
{% endblock %}
